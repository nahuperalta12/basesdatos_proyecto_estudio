CREATE TABLE User
(
  user_id INT IDENTITY NOT NULL,
  username VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  name VARCHAR(50) NOT NULL,
  surname VARCHAR(50) NOT NULL,
  email VARCHAR(80) NOT NULL UNIQUE,
  active INT NOT NULL CHECK (active IN (0, 1)),
  usert_type INT NOT NULL CHECK (user_type IN (1, 2, 3)),
  token_activation VARCHAR(100) NULL,
  token_reset VARCHAR(100) NULL,
  token_reset_expires_at NULL,
  created_at DATE NOT NULL DEFAULT GETDATE(),
  updated_at DATE NOT NULL DEFAULT GETDATE(),
  PRIMARY KEY (user_id)
);

CREATE TABLE Product_category
(
  category_id INT NOT NULL,
  category_description VARCHAR(100) NOT NULL,
  PRIMARY KEY (category_id)
);

CREATE TABLE Message
(
  message_id INT NOT NULL,
  message_name VARCHAR(80) NOT NULL,
  message_mail VARCHAR(80) NOT NULL,
  mail_subject VARCHAR(100) NOT NULL,
  mail_context VARCHAR(255) NOT NULL,
  read INT NOT NULL,
  reply INT NOT NULL,
  id_user INT NOT NULL,
  PRIMARY KEY (message_id),
  FOREIGN KEY (id_user) REFERENCES User(user_id)
);

CREATE TABLE Payment_method
(
  method_id INT NOT NULL,
  method_name VARCHAR(25) NOT NULL,
  ADD CONSTRAINT PK_method_id PRIMARY KEY (method_id)
);

CREATE TABLE Payment_status
(
  status_id INT NOT NULL,
  status_name VARCHAR(25) NOT NULL,
  ADD CONSTRAINT PK_status_id PRIMARY KEY (status_id)
);

CREATE TABLE Country
(
  country_id INT NOT NULL,
  country_name VARCHAR(100) NOT NULL,
  ADD CONSTRAINT PK_country_id PRIMARY KEY (country_id)
);

CREATE TABLE Product
(
  product_id INT NOT NULL,
  product_name VARCHAR(100) NOT NULL,
  product_description VARCHAR(255) NOT NULL,
  product_price FLOAT NOT NULL,
  sold_count INT NOT NULL,
  product_status INT NOT NULL,
  id_category INT NOT NULL,
  ADD CONSTRAINT PK_product_id PRIMARY KEY (product_id),
  ADD CONSTRAINT FK_product_id_id_category FOREIGN KEY (id_category) REFERENCES Product_category(category_id)
);

CREATE TABLE Product_image
(
  imagen_id INT NOT NULL,
  imagen_rute VARCHAR(255) NOT NULL,
  id_product INT NOT NULL,
  ADD CONSTRAINT PK_imagen_id PRIMARY KEY (imagen_id),
  ADD CONSTRAINT FK_imagen_id_id_product FOREIGN KEY (id_product) REFERENCES Product(product_id)
);

CREATE TABLE Payment
(
  payment_id INT NOT NULL,
  payment_date DATE NOT NULL,
  id_status INT NOT NULL,
  id_method INT NOT NULL,
  ADD CONSTRAINT PK_payment_id PRIMARY KEY (payment_id),
  ADD CONSTRAINT FK_status_FOREIGN KEY (status_id) REFERENCES Payment_status(status_id),
  ADD CONSTRAINT FK_status_id_id_method FOREIGN KEY (id_method) REFERENCES Payment_method(id_method)
);

CREATE TABLE Province
(
  province_id INT NOT NULL,
  id_country INT NOT NULL,
  ADD CONSTRAINT PK_province_id_id_country PRIMARY KEY (province_id, id_country),
  ADD CONSTRAINT FK__province_id_id_country_id_country FOREIGN KEY (id_country) REFERENCES Country(country_id)
);

CREATE TABLE City
(
  city_id INT NOT NULL,
  postal_code VARCHAR(20) NOT NULL,
  id_province INT NOT NULL,
  id_country INT NOT NULL,
  ADD CONSTRAINT PK_city_id_id_province_id_country PRIMARY KEY (city_id, id_province, id_country),
  ADD CONSTRAINT FK_city_id_id_province_id_country FOREIGN KEY (id_province, id_country) REFERENCES Province(province_id, id_country)
);

CREATE TABLE Billing_address
(
  billing_id INT NOT NULL,
  address_line1 VARCHAR(255) NOT NULL,
  adress_line2 VARCHAR(255) NOT NULL,
  created_at DATE NOT NULL,
  updated_at DATE NOT NULL,
  id_city INT NOT NULL,
  id_province INT NOT NULL,
  id_country INT NOT NULL,
  ADD CONSTRAINT PK_billing_id PRIMARY KEY (billing_id),
  ADD CONSTRAINT FK_billing_id_id_city_id_province_id_country FOREIGN KEY (id_city, id_province, id_country) REFERENCES City(city_id, id_province, id_country)
);

CREATE TABLE Sale
(
  sale_id INT NOT NULL,
  sale_date DATE NOT NULL,
  id_client INT NOT NULL,
  id_billing INT NOT NULL,
  id_payment INT NOT NULL,
  ADD CONSTRAINT PK_sale_id PRIMARY KEY (sale_id),
  ADD CONSTRAINT FK_sale_id_id_client FOREIGN KEY (id_client) REFERENCES User(user_id),
  ADD CONSTRAINT FK_sale_id_id_billing FOREIGN KEY (id_billing) REFERENCES Billing_address(billing_id),
  ADD CONSTRAINT FK_sale_id_id_payment FOREIGN KEY (id_payment) REFERENCES Payment(id_payment)
);

CREATE TABLE Sale_detail
(
  sale_detail_id INT NOT NULL,
  quantity_detail INT NOT NULL,
  price_detail FLOAT NOT NULL,
  id_sale INT NOT NULL,
  id_product INT NOT NULL,
  ADD CONSTRAINT PK_sale_detail_id PRIMARY KEY (sale_detail_id),
  ADD CONSTRAINT FK_sale_detail_id_id_sale FOREIGN KEY (id_sale) REFERENCES Sale(sale_id),
  ADD CONSTRAINT PK_sale_detail_id_id_product FOREIGN KEY (id_product) REFERENCES Product(product_id)
);
